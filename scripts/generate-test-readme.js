#!/usr/bin/env node

/**
 * Generate comprehensive test results README
 * Creates a detailed README file for test results artifacts
 */

const fs = require('fs');
const path = require('path');

function generateTestResultsREADME() {
  console.log('üìñ Generating comprehensive test results README...');

  try {
    const reportsDir = path.join(process.cwd(), 'test-results');

    if (!fs.existsSync(reportsDir)) {
      fs.mkdirSync(reportsDir, { recursive: true });
    }

    const readmeContent = generateREADMEContent();

    fs.writeFileSync(path.join(reportsDir, 'README.md'), readmeContent);

    console.log('‚úÖ Test results README generated successfully');

  } catch (error) {
    console.error('‚ùå Error generating test results README:', error.message);
  }
}

function generateREADMEContent() {
  const timestamp = new Date().toISOString();

  return `# Test Results

> **Generated on:** ${new Date(timestamp).toLocaleString()}
> **Build:** ${process.env.GITHUB_RUN_ID || 'Local Build'}
> **Commit:** ${process.env.GITHUB_SHA || 'Local'}
> **Branch:** ${process.env.GITHUB_REF_NAME || 'main'}

## üìä Overview

This directory contains comprehensive test results and reports generated by the GitHub Actions CI/CD pipeline. The test suite includes unit tests, integration tests, and performance benchmarks for the Code Review Action.

## üìÅ File Structure

### Coverage Reports
- \`coverage/\` - Jest coverage reports in multiple formats
  - \`lcov.info\` - LCOV format for external tools
  - \`coverage-final.json\` - Machine-readable coverage data
  - \`lcov-report/\` - HTML coverage visualization
  - \`clover.xml\` - Clover XML format

### Test Results
- \`junit.xml\` - JUnit XML for CI/CD integration
- \`test-report.html\` - Interactive HTML test report
- \`test-performance.json\` - Detailed performance metrics
- \`test-summary.md\` - Test results summary

### Reports & Analysis
- \`coverage-report.html\` - Comprehensive coverage analysis
- \`coverage-summary.md\` - Coverage summary for GitHub
- \`coverage-badge.svg\` - Visual coverage badge
- \`integration-test-summary.md\` - Integration test results
- \`test-execution-summary.md\` - Action integration test results

### Trend Analysis
- \`trends/\` - Historical performance and coverage trends
  - \`test-history.json\` - Raw historical data
  - \`trend-analysis.json\` - Processed trend analysis
  - \`trend-report.html\` - Interactive trend visualization

## üéØ Test Categories

### Unit Tests
- **Purpose:** Test individual functions and components in isolation
- **Coverage:** All source files in \`src/\` directory
- **Framework:** Jest with TypeScript support

### Integration Tests
- **Purpose:** Test complete action workflow and scenarios
- **Scenarios:**
  - Basic code review workflow
  - Security issues detection
  - Performance issues analysis
  - Multi-provider coordination
  - Error handling and recovery
  - Configuration validation

### Performance Tests
- **Metrics Tracked:**
  - Test execution time
  - Memory usage
  - Slowest test identification
  - Performance trends over time

## üìà Coverage Metrics

The following coverage metrics are tracked:

| Metric | Description |
|--------|-------------|
| **Statements** | Percentage of executable statements covered |
| **Branches** | Percentage of conditional branches covered |
| **Functions** | Percentage of functions covered |
| **Lines** | Percentage of lines covered |

**Target Coverage:** 80% for all metrics

## üîç Viewing Reports

### HTML Reports
1. Download the artifact from the GitHub Actions run
2. Open \`coverage-report.html\` in a web browser for detailed coverage analysis
3. Open \`test-report.html\` for interactive test results
4. Open \`trends/trend-report.html\` for performance trends

### JSON Data
- Use \`coverage-final.json\` for programmatic coverage analysis
- Use \`test-performance.json\` for performance data integration
- Use \`trends/test-history.json\` for custom trend analysis

### Integration with CI/CD
- \`junit.xml\` can be consumed by most CI/CD platforms
- \`lcov.info\` integrates with coverage services like Codecov
- \`coverage-summary.md\` can be posted as PR comments

## ‚ö° Performance Benchmarks

### Current Performance Targets
- **Total Test Duration:** < 2 minutes
- **Individual Test Duration:** < 10 seconds
- **Memory Usage:** < 512MB peak

### Performance Monitoring
- Execution time is tracked for each test run
- Memory usage patterns are monitored
- Performance trends are analyzed over time
- Slow tests are identified and flagged

## üèÜ Quality Gates

The following quality gates are enforced:

- ‚úÖ All tests must pass
- ‚úÖ Coverage must be ‚â• 80%
- ‚úÖ No new security vulnerabilities
- ‚úÖ Tests must complete within time limits
- ‚úÖ No memory leaks in test execution

## üõ†Ô∏è Debugging Failed Tests

### Test Log Analysis
1. Check the GitHub Actions run logs for error messages
2. Download the test results artifact
3. Review \`junit.xml\` for detailed failure information
4. Check performance metrics for timeout issues

### Common Issues
- **Timeouts:** Increase test timeout in \`jest.config.js\`
- **Memory Issues:** Check for memory leaks in test setup/teardown
- **Coverage Drops:** Review recent code changes for untested code
- **Flaky Tests:** Check for race conditions or external dependencies

## üìû Getting Help

### Troubleshooting Steps
1. Check this README for file locations and formats
2. Review the GitHub Actions workflow logs
3. Examine the specific test failure in the HTML report
4. Check performance metrics for resource constraints
5. Review trend analysis for recent changes

### Documentation
- [Main Project README](../../README.md)
- [Development Guide](../../docs/DEVELOPMENT.md)
- [Testing Strategy](../../docs/TESTING.md)

---

**Note:** This file is automatically generated during test execution. Do not edit manually.

*Generated by Code Review Action Test Pipeline*
`;
}

if (require.main === module) {
  generateTestResultsREADME();
}

module.exports = { generateTestResultsREADME };
